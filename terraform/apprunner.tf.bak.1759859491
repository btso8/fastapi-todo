# App Runner VPC connector so the service can reach private RDS
# resource "aws_apprunner_vpc_connector" "this" {
  vpc_connector_name = "${local.name_prefix}-connector"
  subnets            = [aws_subnet.private_a.id, aws_subnet.private_b.id]
  security_groups    = [aws_security_group.apprunner_vpc.id]
# }

# Choose image based on phase
locals {
  public_placeholder_image = "public.ecr.aws/docker/library/nginx:alpine"
  private_ecr_image        = "${aws_ecr_repository.app.repository_url}:latest"
  chosen_image             = var.use_private_ecr_image ? local.private_ecr_image : local.public_placeholder_image
# }

resource "aws_apprunner_service" "app" {
  service_name = "${local.name_prefix}-svc"

  source_configuration {
    image_repository {
      image_repository_type = var.use_private_ecr_image ? "ECR" : "ECR_PUBLIC"
      image_identifier      = local.chosen_image

      image_configuration {
        port = tostring(var.apprunner_port)

        # ✅ maps (key=value), not list of {name,value}
        runtime_environment_variables = {
          UVICORN_WORKERS = "2"
        }

        # ✅ maps (key=secret-arn)
        runtime_environment_secrets = {
          DATABASE_URL = aws_secretsmanager_secret.database_url.arn
        }
      }
    }

    auto_deployments_enabled = true

    authentication_configuration {
      access_role_arn = aws_iam_role.apprunner_service.arn
    }
  }

  instance_configuration {
    instance_role_arn = aws_iam_role.apprunner_instance.arn
    cpu               = var.apprunner_cpu
    memory            = var.apprunner_memory
  }

  network_configuration {
    egress_configuration {
    egress_type = "DEFAULT"
    # vpc_connector_arn = aws_apprunner_vpc_connector.this.arn
    }
  }

  health_check_configuration {
    protocol            = "HTTP"
    path                = "/"
    healthy_threshold   = 1
    unhealthy_threshold = 5
    interval            = 10
    timeout             = 5
  }

  observability_configuration {
    observability_enabled = true
  }

  tags = {
    Name = "${local.name_prefix}-apprunner"
  }

  depends_on = [
    aws_secretsmanager_secret_version.database_url_v
  ]
# }
